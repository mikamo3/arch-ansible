- name: update pacman cache
  pacman:
    update_cache: yes
  changed_when: False

- name: install base packages
  pacman:
    name:
      - ntfs-3g
      - gparted
      - archlinux-keyring
      - base
      - base-devel
      - bat
      - coreutils
      - dmidecode
      - exa
      - fzf
      - git
      - htop
      - inetutils
      - iperf
      - jdk-openjdk
      - jq
      - less
      - lha
      - libxml2
      - linux-headers
      - linux-zen-headers
      - neofetch
      - neovim
      - net-tools
      - networkmanager
      - nodejs
      - npm
      - p7zip
      - pacman-contrib
      - pkgfile
      - powerline
      - python
      - python-pip
      - ripgrep
      - smartmontools
      - sshpass
      - tcpdump
      - the_silver_searcher
      - unarchiver
      - unrar
      - unzip
      - usbutils
      - vi
      - wget
      - xclip
      - xdg-utils
      - xsel
      - xz
      - yarn
      - zip

- name: install reflector
  pacman:
    name: reflector
  register: reflector_output

- name: run reflector
  command: reflector --country 'JP' --latest 5 --sort rate --save /etc/pacman.d/mirrorlist
  when: reflector_output.changed

- name: reflector hook
  block:
    - name: create hooks directory
      file:
        path: /etc/pacman.d/hooks
        state: directory
        owner: root
        group: root
        mode: 0755
    - name: copy pacman hooks
      copy:
        src: mirrorupgrade.hook
        dest: /etc/pacman.d/hooks/mirrorupgrade.hook

- name: create user `aur`
  become: true
  user:
    name: aur
    create_home: yes
    group: wheel

- name: Allow the `aur` user to run `sudo pacman` without a password
  become: true
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/11-install-aur
    line: "aur ALL=(ALL) NOPASSWD: /usr/bin/pacman"
    create: yes
    mode: 0644
    validate: "visudo -cf %s"

- name: install yay
  become: true
  become_user: aur
  aur:
    use: makepkg
    name: yay
- name: install base packages(aur)
  become: true
  become_user: aur
  aur:
    name:
      - mimeo
      - procs

- name: "install {{ microcode }}-ucode"
  pacman:
    name: "{{ microcode }}-ucode"
  when: microcode is defined

- name: change mkinitcpio.conf
  lineinfile:
    path: /etc/mkinitcpio.conf
    regexp: '^HOOKS=\(\s*base\s+(?!.*\bmicrocode\b).*\)$'
    line: HOOKS=(base microcode \g<1>)
    backrefs: yes
    state: present

- name: copy hostname
  template:
    src: hostname.j2
    dest: /etc/hostname
    mode: 0644

- name: copy hosts
  template:
    src: hosts.j2
    dest: /etc/hosts
    mode: 0644

- name: install cronie
  pacman:
    name: cronie

- name: enable cronie
  service:
    name: cronie
    enabled: true

- name: enable suspend
  lineinfile:
    path: /etc/systemd/logind.conf
    regexp: '^\s*HandlePowerKey='
    line: "HandlePowerKey=suspend"
    insertafter: '\[login\]'
